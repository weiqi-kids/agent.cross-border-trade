name: Check Links & Auto-fix 404

on:
  # éƒ¨ç½²å®Œæˆå¾Œæª¢æŸ¥
  workflow_run:
    workflows: ["Deploy Jekyll to GitHub Pages"]
    types:
      - completed
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
  # æ¯é€±ä¸€æª¢æŸ¥
  schedule:
    - cron: '0 0 * * 1'

permissions:
  contents: write
  pull-requests: write

jobs:
  check-links:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name != 'workflow_run' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get site URL
        id: site-url
        run: |
          # å¾ GitHub Pages è¨­å®šæ¨æ–· URL
          REPO_NAME="${{ github.repository }}"
          OWNER="${REPO_NAME%%/*}"
          REPO="${REPO_NAME##*/}"
          echo "url=https://${OWNER}.github.io/${REPO}" >> $GITHUB_OUTPUT

      - name: Check internal links
        id: check-links
        run: |
          echo "Checking links in docs/"

          # æ”¶é›†æ‰€æœ‰ markdown æ–‡ä»¶ä¸­çš„å…§éƒ¨é€£çµ
          BROKEN_LINKS=""

          find docs -name "*.md" -type f | while read -r file; do
            # æå– markdown é€£çµ [text](link)
            grep -oE '\[([^\]]+)\]\(([^)]+)\)' "$file" 2>/dev/null | while read -r match; do
              link=$(echo "$match" | sed 's/.*](\([^)]*\))/\1/')

              # è·³éå¤–éƒ¨é€£çµå’ŒéŒ¨é»
              if [[ "$link" =~ ^https?:// ]] || [[ "$link" =~ ^# ]] || [[ "$link" =~ ^mailto: ]]; then
                continue
              fi

              # è¨ˆç®—ç›®æ¨™è·¯å¾‘
              dir=$(dirname "$file")
              if [[ "$link" =~ ^/ ]]; then
                target="docs${link}"
              else
                target="$dir/$link"
              fi

              # ç§»é™¤ .html å¾Œç¶´ä¸¦åŠ ä¸Š .md
              target=$(echo "$target" | sed 's/\.html$//')

              # æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
              if [[ ! -f "${target}.md" ]] && [[ ! -f "$target/index.md" ]] && [[ ! -d "$target" ]]; then
                echo "BROKEN: $file -> $link (target: $target)" >> /tmp/broken-links.txt
              fi
            done
          done

          if [[ -f /tmp/broken-links.txt ]]; then
            echo "Found broken links:"
            cat /tmp/broken-links.txt
            echo "has_broken_links=true" >> $GITHUB_OUTPUT

            # ä¿å­˜åˆ°ç’°å¢ƒè®Šæ•¸
            {
              echo 'broken_links<<EOF'
              cat /tmp/broken-links.txt
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          else
            echo "No broken links found"
            echo "has_broken_links=false" >> $GITHUB_OUTPUT
          fi

      - name: Attempt auto-fix
        if: steps.check-links.outputs.has_broken_links == 'true'
        run: |
          echo "Attempting to fix broken links..."

          # è®€å–æå£çš„é€£çµ
          while IFS= read -r line; do
            # è§£æ: BROKEN: source_file -> link (target: expected_target)
            source_file=$(echo "$line" | sed 's/BROKEN: \([^ ]*\) -> .*/\1/')
            link=$(echo "$line" | sed 's/.*-> \([^ ]*\) .*/\1/')
            target=$(echo "$line" | sed 's/.*(target: \([^)]*\))/\1/')

            echo "Checking: $source_file -> $link"

            # å˜—è©¦æ‰¾åˆ°æ­£ç¢ºçš„æ–‡ä»¶
            base_name=$(basename "$link" | sed 's/\.md$//' | sed 's/\.html$//')

            # æœå°‹å¯èƒ½çš„åŒ¹é…
            found=$(find docs -name "${base_name}*.md" -o -name "${base_name}" -type d | head -1)

            if [[ -n "$found" ]]; then
              echo "Found potential match: $found"

              # è¨ˆç®—ç›¸å°è·¯å¾‘
              source_dir=$(dirname "$source_file")
              new_link=$(python3 -c "import os.path; print(os.path.relpath('$found', '$source_dir'))" | sed 's/\.md$//')

              echo "Suggested fix: $link -> $new_link"

              # åŸ·è¡Œæ›¿æ›
              sed -i.bak "s|]($link)|]($new_link)|g" "$source_file"
              rm -f "${source_file}.bak"

              echo "Fixed in $source_file"
            fi
          done < /tmp/broken-links.txt

      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git diff --stat
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix: auto-fix broken links"
          title: "ğŸ”— Auto-fix broken links"
          body: |
            This PR was automatically created to fix broken links detected in the documentation.

            ## Broken links detected:
            ```
            ${{ steps.check-links.outputs.broken_links }}
            ```

            Please review the changes before merging.
          branch: fix/broken-links
          delete-branch: true

      - name: Report status
        if: always()
        run: |
          if [[ "${{ steps.check-links.outputs.has_broken_links }}" == "true" ]]; then
            echo "::warning::Broken links were detected. Check the workflow output for details."
            if [[ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]]; then
              echo "::notice::A PR has been created with suggested fixes."
            fi
          else
            echo "::notice::All links are valid!"
          fi
